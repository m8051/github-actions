---
name: GitHub Actions CI/CD
on:
  pull_request:
    types:
      - opened
      - synchronize
      - closed
      
# Using concurrency and the default behavior
concurrency: ci-${{ github.ref }}

jobs:

  # Monitor Customer Portal File Changes
  changes:
    name: Monitor changes
    strategy:
      matrix:
        branches: [souls/development, souls/staging, souls/production]
    runs-on: ubuntu-latest
    steps:
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          frontend-iac:
            - 'infrastructure/frontend/**'
          backend-iac:
            - 'infrastructure/backend/**'
    - id: target
      if: ${{ matrix.branches == github.event.pull_request.base.ref }}
      run: echo "branch=${{ matrix.branches }}" >> "$GITHUB_OUTPUT"
    outputs:
      frontend-iac: ${{ steps.changes.outputs.frontend-iac }}
      backend-iac: ${{ steps.changes.outputs.backend-iac }}
      branch: ${{ steps.target.outputs.branch }}


  # All
  release:
    name: Deploy
    needs: [changes]
    if: ${{ (github.event.pull_request.base.ref == needs.changes.outputs.branch) &&
      (( needs.changes.outputs.frontend-iac == 'true') || (needs.changes.outputs.backend-iac == 'true')) }}
    uses: ./.github/workflows/terraform.yml
    secrets: inherit
    with:
      directory: infrastructure/backend/
      environment: ${{ needs.changes.outputs.branch }}
      branch: ${{ needs.changes.outputs.branch }}

  # # All
  # release:
  #   name: Deploy
  #   needs: [changes]
  #   if: ${{ (github.event.pull_request.merged == true) && (github.event.pull_request.base.ref == needs.changes.outputs.branch) &&
  #     (( needs.changes.outputs.frontend-iac == 'true') || (needs.changes.outputs.backend-iac == 'true')) }}
  #   uses: ./.github/workflows/terraform.yml
  #   secrets: inherit
  #   with:
  #     directory: infrastructure/backend/
  #     environment: ${{ needs.changes.outputs.branch }}
  #     branch: ${{ needs.changes.outputs.branch }}
 
  # terraform:
  #   name: Terraform
  #   needs: [changes]
  #   if: ${{ (github.event.pull_request.merged == false) && (github.event.pull_request.base.ref == needs.changes.outputs.branch) &&
  #     (needs.changes.outputs.frontend-iac == 'false') && (needs.changes.outputs.backend-iac == 'true') }}
  #   uses: ./.github/workflows/terraform.yml
  #   secrets: inherit
  #   with:
  #     directory: infrastructure/backend/
  #     environment: ${{ needs.changes.outputs.branch }}
  #     branch: ${{ needs.changes.outputs.branch }}

